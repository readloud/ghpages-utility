###
Convert heading text into anchor link, using the algorithm from
https://github.com/jch/html-pipeline/blob/master/lib/html/pipeline/toc_filter.rb
as described in
https://gist.github.com/asabaylus/3071099
###
headingToAnchor = (heading, headings) ->
  heading = heading
  .toLowerCase()
  .replace /[^\w\- ]/g, ''
  .replace /[ ]/g, '-'
  if headings[heading]
    heading += "-#{headings[heading]++}"
  else
    headings[heading] = 1
  heading

###
HTML open tag regex from
https://github.com/markdown-it/markdown-it/blob/df4607f1d4d4be7fdc32e71c04109aea8cc373fa/lib/common/html_re.js
modified to capture tag name and attributes and their names and values.
###
attr_name     = '([a-zA-Z_:][a-zA-Z0-9:._-]*)'
unquoted      = '([^"\'=<>`\\x00-\\x20]+)'
single_quoted = "'([^']*)'"
double_quoted = '"([^"]*)"'
attr_value    = "(?:#{unquoted}|#{single_quoted}|#{double_quoted})"
attribute     = "(?:\\s+#{attr_name}(?:\\s*=\\s*#{attr_value})?)"
open_tag      = "<([A-Za-z][A-Za-z0-9\\-]*)(#{attribute}*)\\s*\\/?>"
attribute_re  = new RegExp attribute, 'g'
open_tag_re   = new RegExp open_tag

module.exports =
  names: ['github-internal-links']
  description: 'Check internal links like those generated by Github'
  tags: ['links']
  function: ({name, tokens, config}, onError) ->
    links = []
    heading = null
    headings = {}
    for token in tokens
      switch token.type
        when 'inline'
          for child in token.children
            switch child.type
              when 'link_open'
                for [key, value] in child.attrs
                  if key == 'href' and value?.startsWith '#'
                    links.push
                      anchor: value[1..]
                      lineNumber: child.lineNumber
              when 'html_inline'
                if tag_match = open_tag_re.exec child.content
                  tag = tag_match[1].toLowerCase()
                  attributes = tag_match[2]
                  while attr_match = attribute_re.exec attributes
                    key = attr_match[1].toLowerCase()
                    value = attr_match[2] ? attr_match[3] ? attr_match[4]
                    if (key == 'id' or (key == 'name' and tag == 'a')) and value
                      headings[value] = 1
                      if config.verbose
                        console.log "#{name}:#{token.lineNumber} github-internal-links ##{value} = <#{tag} #{key}>"
              when 'text', 'code_inline'
                heading += child.content if heading?
        when 'heading_open'
          heading = ''
          headingLineNumber = token.lineNumber
        when 'heading_close'
          anchor = headingToAnchor heading, headings
          if config.verbose
            console.log "#{name}:#{headingLineNumber} github-internal-links ##{anchor} = #{heading}"
          heading = null
    for {anchor, lineNumber} in links
      unless anchor of headings
        onError
          lineNumber: lineNumber
          detail: 'Internal anchor link does not match any heading'
          context: "##{anchor}"
      else if config.verbose
        console.log "#{name}:#{lineNumber} github-internal-links Link ##{anchor} OK"
    undefined
